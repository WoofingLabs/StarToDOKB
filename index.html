<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAR 与 OKB NFT 兑换</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #fff;
        }
        h1 {
            font-size: 36px;
            color: #ff8c00;
            margin-bottom: 10px;
        }
        .wallet-info {
            margin: 10px 0;
            font-size: 16px;
            background: #2d2d2d;
            padding: 10px;
            border-radius: 5px;
        }
        .action-btn {
            padding: 12px 24px;
            font-size: 16px;
            background: #ff8c00;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .action-btn:hover {
            background: #e07b00;
        }
        .action-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .action-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: #fff;
            max-width: 400px;
            width: 90%;
        }
        .modal-content p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        .modal-content button {
            padding: 8px 16px;
            background: #ff8c00;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .section {
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .section h2 {
            font-size: 24px;
            color: #ff8c00;
            margin-bottom: 15px;
        }
        .section label {
            font-size: 14px;
            color: #ff8c00;
            display: block;
            margin-bottom: 5px;
        }
        .section input, .section select, .section textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ff8c00;
            background: #1a1a1a;
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .section input[type="number"] {
            -moz-appearance: textfield;
        }
        .section input::-webkit-outer-spin-button,
        .section input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .section textarea {
            resize: vertical;
            min-height: 100px;
        }
        .nft-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
        }
        .nft-list p {
            margin: 5px 0;
        }
        .exchange-info {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group input {
            flex: 1;
        }
        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            .wallet-info { font-size: 14px; }
            .action-btn { padding: 10px 20px; font-size: 14px; }
            .section { padding: 15px; }
            .section h2 { font-size: 20px; }
            .section input, .section select, .section textarea { font-size: 12px; }
            .input-group { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>STAR 与 OKB NFT 兑换</h1>
        <div class="wallet-info">
            钱包地址: <span id="walletAddress">未连接</span><br>
            STAR 余额: <span id="starBalance">0</span>
        </div>
        <button id="connectWalletBtn" class="action-btn">连接钱包</button>
    </div>

    <div class="section">
        <h2>用 STAR 兑换 NFT</h2>
        <div class="exchange-info">
            当前兑换率: <span id="exchangeRate">100000 STAR/NFT</span><br>
            STAR 代币地址: 0x552473d6b6b72092aaecd8c4290b91a4db89e7f6
        </div>
        <label for="exchangeTokenId">输入或选择要兑换的 NFT (tokenId):</label>
        <input type="number" id="exchangeTokenId" placeholder="输入 tokenId 或从下拉框选择">
        <select id="availableTokenIds" onchange="document.getElementById('exchangeTokenId').value = this.value;">
            <option value="">从可用 NFT 选择</option>
        </select>
        <button id="approveStarBtn" class="action-btn" onclick="approveStarToken()" disabled>授权 STAR</button>
        <button id="exchangeBtn" class="action-btn" onclick="exchangeNFT()" disabled>兑换 NFT</button>
    </div>

    <div class="section">
        <h2>获取您的 NFT</h2>
        <label for="contractAddress">NFT 合约地址:</label>
        <input type="text" id="contractAddress" value="0xbf13ed020dcf22bc8216a23a1167a5dd1fdc2d0e" readonly>
        <div class="input-group">
            <input type="number" id="startTokenId" placeholder="起始 tokenId">
            <input type="number" id="tokenCount" placeholder="查询数量">
        </div>
        <button id="fetchNFTsBtn" class="action-btn" onclick="fetchOwnedNFTs()" disabled>获取我的 NFT</button>
        <label for="ownedNFTs">您的 NFT (tokenId，逗号分隔，可复制):</label>
        <textarea id="ownedNFTs" readonly placeholder="查询后显示您的 NFT tokenId"></textarea>
    </div>

    <div class="section">
        <h2>批量充值 NFT</h2>
        <label for="depositTokenIds">选择要充值的 NFT (tokenId，逗号分隔):</label>
        <input type="text" id="depositTokenIds" placeholder="例如: 10001,10002,10003">
        <button id="approveNFTBtn" class="action-btn" onclick="approveNFTContract()" disabled>授权 NFT</button>
        <button id="depositNFTsBtn" class="action-btn" onclick="depositNFTs()" disabled>充值 NFT</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="closeModal()">确定</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, starContract, nftContract, exchangeContract;
        const EXCHANGE_CONTRACT_ADDRESS = "0xc6d2f8b932d15e7ce978e53b32ad0bc375d2ca89";
        const STAR_TOKEN_ADDRESS = "0x552473d6b6b72092aaecd8c4290b91a4db89e7f6";
        const OKB_NFT_ADDRESS = "0xbf13ed020dcf22bc8216a23a1167a5dd1fdc2d0e";
        const X_LAYER_CHAIN_ID = "0xc4"; // Chain ID 196
        let cachedTokenIds = new Set(), availableTokenIds = [], exchangeRate = 0;

        const ERC20_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "spender", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "owner", "type": "address"},
                    {"internalType": "address", "name": "spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const ERC721_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "owner", "type": "address"},
                    {"internalType": "address", "name": "operator", "type": "address"}
                ],
                "name": "isApprovedForAll",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "operator", "type": "address"},
                    {"internalType": "bool", "name": "_approved", "type": "bool"}
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "ownerOf",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "tokenURI",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const EXCHANGE_ABI = [
            {
                "inputs": [{"internalType": "uint256", "name": "_tokenId", "type": "uint256"}],
                "name": "exchange",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256[]", "name": "_tokenIds", "type": "uint256[]"}],
                "name": "depositNFTs",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "exchangeRate",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAvailableTokenIds",
                "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "page", "type": "uint256"},
                    {"internalType": "uint256", "name": "pageSize", "type": "uint256"}
                ],
                "name": "getAvailableTokenIdsPaginated",
                "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getStarDecimals",
                "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        async function switchToXLayer() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: X_LAYER_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: X_LAYER_CHAIN_ID,
                            chainName: 'X Layer mainnet',
                            nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
                            rpcUrls: ['https://xlayerrpc.okx.com'],
                            blockExplorerUrls: ['https://www.okx.com/web3/explorer/xlayer']
                        }],
                    });
                } else {
                    showModal('请切换到 X Layer 主网（Chain ID: 196）。');
                }
            }
        }

        async function checkNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== X_LAYER_CHAIN_ID) {
                await switchToXLayer();
                const newChainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (newChainId !== X_LAYER_CHAIN_ID) {
                    showModal('请切换到 X Layer 主网（Chain ID: 196）。');
                    return false;
                }
            }
            return true;
        }

        function showModal(message) {
            const modalMessage = document.getElementById('modalMessage');
            if (modalMessage) {
                modalMessage.innerHTML = message;
                document.getElementById('modal').style.display = 'flex';
            } else {
                console.error('Modal message element not found!');
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function retryWithBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.message.includes('429') && i < maxRetries - 1) {
                        console.warn(`429 错误，重试 ${i + 1}/${maxRetries}，延迟 ${delay}ms`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay = Math.min(delay * 2, 8000);
                        continue;
                    }
                    throw error;
                }
            }
        }

        async function connectWallet() {
            const connectButton = document.getElementById('connectWalletBtn');
            connectButton.classList.add('loading');
            if (!window.ethereum) {
                showModal('请安装 MetaMask 钱包。');
                connectButton.classList.remove('loading');
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                if (!(await checkNetwork())) {
                    connectButton.classList.remove('loading');
                    return;
                }
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                starContract = new web3.eth.Contract(ERC20_ABI, STAR_TOKEN_ADDRESS);
                nftContract = new web3.eth.Contract(ERC721_ABI, OKB_NFT_ADDRESS);
                exchangeContract = new web3.eth.Contract(EXCHANGE_ABI, EXCHANGE_CONTRACT_ADDRESS);
                await updateWalletInfo();
                document.getElementById('fetchNFTsBtn').disabled = false;
                document.getElementById('approveNFTBtn').disabled = false;
                document.getElementById('approveStarBtn').disabled = false;
                showModal('钱包已连接！');
                await fetchAvailableNFTs();
            } catch (error) {
                showModal(`连接失败: ${error.message || '未知错误'}`);
                console.error('连接钱包失败:', error);
            } finally {
                connectButton.classList.remove('loading');
            }
        }

        async function updateWalletInfo() {
            if (!accounts || accounts.length === 0) {
                document.getElementById('walletAddress').innerText = '未连接';
                document.getElementById('starBalance').innerText = '0';
                return;
            }
            try {
                document.getElementById('walletAddress').innerText = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                const balance = await retryWithBackoff(() => starContract.methods.balanceOf(accounts[0]).call());
                const decimals = await retryWithBackoff(() => starContract.methods.decimals().call());
                document.getElementById('starBalance').innerText = (balance / 10**decimals).toFixed(2);
                const rate = await retryWithBackoff(() => exchangeContract.methods.exchangeRate().call());
                exchangeRate = rate / 10**decimals;
                document.getElementById('exchangeRate').innerText = `${exchangeRate.toFixed(2)} STAR/NFT`;
            } catch (error) {
                showModal(`更新钱包信息失败: ${error.message || '未知错误'}`);
                console.error('更新钱包信息失败:', error);
            }
        }

        async function fetchOwnedNFTs() {
            if (!(await checkNetwork())) return;
            if (!web3 || !nftContract || !accounts) {
                showModal('请先连接钱包！');
                return;
            }
            const fetchButton = document.getElementById('fetchNFTsBtn');
            fetchButton.classList.add('loading');
            fetchButton.disabled = true;
            const nftList = document.getElementById('nftList');
            const ownedNFTsTextarea = document.getElementById('ownedNFTs');
            if (!nftList || !ownedNFTsTextarea) {
                showModal('页面错误：无法找到 NFT 列表或输出框！请检查页面结构。');
                fetchButton.classList.remove('loading');
                fetchButton.disabled = false;
                return;
            }
            try {
                const startTokenId = parseInt(document.getElementById('startTokenId').value.trim());
                const tokenCount = parseInt(document.getElementById('tokenCount').value.trim());
                if (isNaN(startTokenId) || startTokenId < 0 || isNaN(tokenCount) || tokenCount <= 0 || tokenCount > 100) {
                    showModal('请输入有效的起始 tokenId 和查询数量（最多 100）！');
                    nftList.innerHTML = '<p>请输入有效的起始 tokenId 和查询数量。</p>';
                    ownedNFTsTextarea.value = '';
                    return;
                }
                nftList.innerHTML = '<p>正在查询您的 NFT...</p>';
                ownedNFTsTextarea.value = '查询中...';
                cachedTokenIds = new Set();
                console.log(`开始查询 NFT：起始 tokenId = ${startTokenId}，数量 = ${tokenCount}`);
                for (let i = 0; i < tokenCount; i++) {
                    const tokenId = startTokenId + i;
                    try {
                        const owner = await retryWithBackoff(() => 
                            nftContract.methods.ownerOf(tokenId).call()
                        );
                        console.log(`tokenId ${tokenId} 的拥有者: ${owner}`);
                        if (owner.toLowerCase() === accounts[0].toLowerCase()) {
                            cachedTokenIds.add(tokenId.toString());
                            console.log(`添加 tokenId ${tokenId} 到列表`);
                        }
                    } catch (error) {
                        console.log(`跳过 tokenId ${tokenId}：${error.message}`);
                    }
                }
                const tokenIdList = Array.from(cachedTokenIds).sort((a, b) => a - b).join(',');
                console.log(`查询结果：${tokenIdList || '无 NFT'}`);
                nftList.innerHTML = cachedTokenIds.size > 0 
                    ? `<p>您拥有 ${cachedTokenIds.size} 个 NFT：${Array.from(cachedTokenIds).slice(0, 5).join(', ')}${cachedTokenIds.size > 5 ? ' 等...' : ''}</p>`
                    : '<p>未找到您的 NFT，请检查起始 tokenId 和数量或确认钱包是否持有 NFT。</p>';
                ownedNFTsTextarea.value = tokenIdList || '无 NFT';
                if (cachedTokenIds.size === 0) {
                    showModal('未找到您的 NFT！请确认输入的 tokenId 范围或钱包是否持有 NFT。');
                } else {
                    showModal('NFT 查询完成！请从下方文本框复制 tokenId 列表。');
                }
            } catch (error) {
                console.error(`获取 NFT 失败: ${error.message}`);
                showModal(`获取 NFT 失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}<br>请检查网络连接、输入参数或控制台日志。`);
                nftList.innerHTML = '<p>查询 NFT 失败，请检查控制台日志。</p>';
                ownedNFTsTextarea.value = '查询失败';
            } finally {
                fetchButton.classList.remove('loading');
                fetchButton.disabled = false;
            }
        }

        async function fetchAvailableNFTs() {
            if (!web3 || !exchangeContract) return;
            try {
                availableTokenIds = await retryWithBackoff(() => 
                    exchangeContract.methods.getAvailableTokenIds().call()
                );
                const select = document.getElementById('availableTokenIds');
                select.innerHTML = '<option value="">从可用 NFT 选择</option>';
                for (const tokenId of availableTokenIds) {
                    let nftName = `OKB #${tokenId}`;
                    try {
                        const tokenURI = await retryWithBackoff(() => 
                            nftContract.methods.tokenURI(tokenId).call()
                        );
                        const response = await fetch(tokenURI);
                        const metadata = await response.json();
                        if (metadata.name) {
                            nftName = `${metadata.name}.okb (ID: ${tokenId})`;
                        }
                    } catch (error) {
                        console.warn(`无法获取 tokenId ${tokenId} 的元数据: ${error.message}`);
                    }
                    const option = document.createElement('option');
                    option.value = tokenId;
                    option.text = nftName;
                    select.appendChild(option);
                }
            } catch (error) {
                console.warn(`获取可用 NFT 失败: ${error.message}`);
                showModal('无法获取可用 NFT 列表，请手动输入 tokenId 或稍后重试。');
            }
        }

        async function approveNFTContract() {
            if (!(await checkNetwork())) return;
            if (!web3 || !nftContract || !accounts) {
                showModal('请先连接钱包！');
                return;
            }
            const approveButton = document.getElementById('approveNFTBtn');
            approveButton.classList.add('loading');
            approveButton.disabled = true;
            try {
                const isApproved = await retryWithBackoff(() => 
                    nftContract.methods.isApprovedForAll(accounts[0], EXCHANGE_CONTRACT_ADDRESS).call()
                );
                if (isApproved) {
                    showModal('NFT 合约已授权！');
                    document.getElementById('depositNFTsBtn').disabled = false;
                } else {
                    const gasEstimate = await retryWithBackoff(() => 
                        nftContract.methods.setApprovalForAll(EXCHANGE_CONTRACT_ADDRESS, true).estimateGas({ from: accounts[0] })
                    );
                    await nftContract.methods.setApprovalForAll(EXCHANGE_CONTRACT_ADDRESS, true).send({ 
                        from: accounts[0], 
                        gas: Math.floor(gasEstimate * 1.2) 
                    });
                    showModal('NFT 授权成功！');
                    document.getElementById('depositNFTsBtn').disabled = false;
                }
            } catch (error) {
                showModal(`授权失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}`);
            } finally {
                approveButton.classList.remove('loading');
                approveButton.disabled = false;
            }
        }

        async function approveStarToken() {
            if (!(await checkNetwork())) return;
            if (!web3 || !starContract || !accounts) {
                showModal('请先连接钱包！');
                return;
            }
            const approveButton = document.getElementById('approveStarBtn');
            approveButton.classList.add('loading');
            approveButton.disabled = true;
            try {
                const allowance = await retryWithBackoff(() => 
                    starContract.methods.allowance(accounts[0], EXCHANGE_CONTRACT_ADDRESS).call()
                );
                if (allowance >= exchangeRate * 10**18) {
                    showModal('STAR 代币已授权！');
                    document.getElementById('exchangeBtn').disabled = !document.getElementById('exchangeTokenId').value;
                } else {
                    const gasEstimate = await retryWithBackoff(() => 
                        starContract.methods.approve(EXCHANGE_CONTRACT_ADDRESS, exchangeRate * 10**18).estimateGas({ from: accounts[0] })
                    );
                    await starContract.methods.approve(EXCHANGE_CONTRACT_ADDRESS, exchangeRate * 10**18).send({ 
                        from: accounts[0], 
                        gas: Math.floor(gasEstimate * 1.2) 
                    });
                    showModal('STAR 授权成功！');
                    document.getElementById('exchangeBtn').disabled = !document.getElementById('exchangeTokenId').value;
                }
            } catch (error) {
                showModal(`授权失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}`);
            } finally {
                approveButton.classList.remove('loading');
                approveButton.disabled = false;
            }
        }

        async function depositNFTs() {
            if (!(await checkNetwork())) return;
            if (!web3 || !nftContract || !exchangeContract || !accounts) {
                showModal('请先连接钱包并授权！');
                return;
            }
            const depositButton = document.getElementById('depositNFTsBtn');
            depositButton.classList.add('loading');
            depositButton.disabled = true;
            try {
                const tokenIdsInput = document.getElementById('depositTokenIds').value.trim();
                const tokenIds = tokenIdsInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
                if (tokenIds.length === 0) {
                    showModal('请输入有效的 tokenId！');
                    return;
                }
                for (const tokenId of tokenIds) {
                    const owner = await retryWithBackoff(() => 
                        nftContract.methods.ownerOf(tokenId).call()
                    );
                    if (owner.toLowerCase() !== accounts[0].toLowerCase()) {
                        showModal(`tokenId ${tokenId} 不属于您！`);
                        return;
                    }
                }
                const gasEstimate = await retryWithBackoff(() => 
                    exchangeContract.methods.depositNFTs(tokenIds).estimateGas({ from: accounts[0] })
                );
                await exchangeContract.methods.depositNFTs(tokenIds).send({ 
                    from: accounts[0], 
                    gas: Math.floor(gasEstimate * 1.2) 
                });
                showModal('NFT 充值成功！');
                await fetchOwnedNFTs();
                await fetchAvailableNFTs();
                document.getElementById('depositTokenIds').value = '';
            } catch (error) {
                showModal(`充值失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message || '未知错误'}<br>请确认 tokenId 或授权状态。`);
            } finally {
                depositButton.classList.remove('loading');
                depositButton.disabled = false;
            }
        }

        async function exchangeNFT() {
            if (!(await checkNetwork())) return;
            if (!web3 || !exchangeContract || !accounts) {
                showModal('请先连接钱包并授权！');
                return;
            }
            const exchangeButton = document.getElementById('exchangeBtn');
            exchangeButton.classList.add('loading');
            exchangeButton.disabled = true;
            try {
                const tokenId = document.getElementById('exchangeTokenId').value.trim();
                if (!tokenId || isNaN(tokenId) || parseInt(tokenId) <= 0) {
                    showModal('请输入有效的 tokenId！');
                    return;
                }
                const balance = await retryWithBackoff(() => starContract.methods.balanceOf(accounts[0]).call());
                if (balance < exchangeRate * 10**18) {
                    showModal(`STAR 余额不足！需要 ${exchangeRate} STAR，当前余额 ${(balance / 10**18).toFixed(2)} STAR。`);
                    return;
                }
                const allowance = await retryWithBackoff(() => 
                    starContract.methods.allowance(accounts[0], EXCHANGE_CONTRACT_ADDRESS).call()
                );
                if (allowance < exchangeRate * 10**18) {
                    showModal('请先授权 STAR 代币！');
                    return;
                }
                const gasEstimate = await retryWithBackoff(() => 
                    exchangeContract.methods.exchange(tokenId).estimateGas({ from: accounts[0] })
                );
                await exchangeContract.methods.exchange(tokenId).send({ 
                    from: accounts[0], 
                    gas: Math.floor(gasEstimate * 1.2) 
                });
                showModal('NFT 兑换成功！');
                await fetchOwnedNFTs();
                await fetchAvailableNFTs();
                await updateWalletInfo();
                document.getElementById('exchangeTokenId').value = '';
                document.getElementById('availableTokenIds').value = '';
            } catch (error) {
                showModal(`兑换失败: ${error.message.includes('429') ? 'API 速率限制，请稍后重试' : error.message.includes('Insufficient STAR balance') ? 'STAR 余额不足' : error.message.includes('NFT not in contract') ? '所选 NFT 不可用' : error.message || '未知错误'}`);
            } finally {
                exchangeButton.classList.remove('loading');
                exchangeButton.disabled = !document.getElementById('exchangeTokenId').value;
            }
        }

        window.onload = () => {
            if (!window.ethereum) {
                showModal('请安装 MetaMask 钱包。');
            }
        };

        window.ethereum?.on('chainChanged', () => {
            window.location.reload();
        });

        window.ethereum?.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            cachedTokenIds = new Set();
            availableTokenIds = [];
            updateWalletInfo();
            if (newAccounts.length === 0) {
                document.getElementById('fetchNFTsBtn').disabled = true;
                document.getElementById('approveNFTBtn').disabled = true;
                document.getElementById('depositNFTsBtn').disabled = true;
                document.getElementById('approveStarBtn').disabled = true;
                document.getElementById('exchangeBtn').disabled = true;
            } else {
                connectWallet();
            }
        });

        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('exchangeTokenId').addEventListener('input', () => {
            document.getElementById('exchangeBtn').disabled = !document.getElementById('exchangeTokenId').value;
            document.getElementById('availableTokenIds').value = '';
        });
        document.getElementById('availableTokenIds').addEventListener('change', () => {
            document.getElementById('exchangeTokenId').value = document.getElementById('availableTokenIds').value;
            document.getElementById('exchangeBtn').disabled = !document.getElementById('exchangeTokenId').value;
        });
    </script>
</body>
</html>
